{% extends "base.html" %}

{% block title %}Document Ingestion - Profiler Agentic Automation{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-file-upload"></i> Document Ingestion</h1>
        <p>Upload documentation files to build your knowledge base</p>
        <a href="{{ url_for('training_dashboard') }}" class="btn btn-secondary btn-small">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <div class="upload-section">
        <div class="upload-info">
            <h3>Supported Formats</h3>
            <div class="format-tags">
                {% for format in supported_formats %}
                <span class="format-tag">{{ format }}</span>
                {% endfor %}
            </div>
            <p class="info-text">
                <i class="fas fa-info-circle"></i>
                Maximum file size: 50MB
            </p>
        </div>

        <div class="upload-area" id="upload-area">
            <div class="upload-content">
                <i class="fas fa-cloud-upload-alt"></i>
                <h3>Drag & Drop Files Here</h3>
                <p>or</p>
                <label for="file-input" class="btn btn-primary">
                    <i class="fas fa-folder-open"></i> Browse Files
                </label>
                <input type="file" id="file-input" multiple accept="{{ supported_formats|join(',') }}" style="display: none;">
            </div>
        </div>

        <!-- Upload Queue -->
        <div id="upload-queue" class="upload-queue" style="display: none;">
            <h3>Upload Queue</h3>
            <div id="queue-items"></div>
        </div>

        <!-- Upload Log -->
        <div class="upload-log">
            <h3>
                <i class="fas fa-terminal"></i> Ingestion Log
                <button id="clear-log-btn" class="btn btn-small btn-secondary" style="float: right;">
                    <i class="fas fa-trash"></i> Clear Log
                </button>
            </h3>
            <div id="log-output" class="log-output">
                <p class="log-entry info">Ready to ingest documents...</p>
            </div>
        </div>
    </div>
</div>

<script>
const uploadArea = document.getElementById('upload-area');
const fileInput = document.getElementById('file-input');
const uploadQueue = document.getElementById('upload-queue');
const queueItems = document.getElementById('queue-items');
const logOutput = document.getElementById('log-output');

// Prevent default drag behaviors
['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, preventDefaults, false);
    document.body.addEventListener(eventName, preventDefaults, false);
});

function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

// Highlight drop area
['dragenter', 'dragover'].forEach(eventName => {
    uploadArea.addEventListener(eventName, () => uploadArea.classList.add('highlight'), false);
});

['dragleave', 'drop'].forEach(eventName => {
    uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('highlight'), false);
});

// Handle drop
uploadArea.addEventListener('drop', handleDrop, false);
fileInput.addEventListener('change', handleFileSelect, false);

function handleDrop(e) {
    const files = e.dataTransfer.files;
    handleFiles(files);
}

function handleFileSelect(e) {
    const files = e.target.files;
    handleFiles(files);
}

function handleFiles(files) {
    uploadQueue.style.display = 'block';
    Array.from(files).forEach(uploadFile);
}

function uploadFile(file) {
    // Add to queue
    const queueItem = document.createElement('div');
    queueItem.className = 'queue-item';
    queueItem.innerHTML = `
        <div class="queue-item-info">
            <i class="fas fa-file"></i>
            <span>${file.name}</span>
            <span class="file-size">(${formatFileSize(file.size)})</span>
        </div>
        <div class="queue-item-status">
            <span class="status-text">Uploading...</span>
            <div class="progress-bar">
                <div class="progress-fill" style="width: 0%"></div>
            </div>
        </div>
    `;
    queueItems.appendChild(queueItem);

    // Log
    addLog(`Starting upload: ${file.name}`, 'info');

    // Upload
    const formData = new FormData();
    formData.append('file', file);

    fetch('/training/upload-document', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            queueItem.querySelector('.status-text').innerHTML = '<i class="fas fa-check"></i> Success';
            queueItem.querySelector('.progress-fill').style.width = '100%';
            queueItem.classList.add('success');
            addLog(`✓ Successfully ingested: ${file.name} (${data.chunks} chunks)`, 'success');
        } else {
            queueItem.querySelector('.status-text').innerHTML = '<i class="fas fa-times"></i> Failed';
            queueItem.classList.add('error');
            addLog(`✗ Failed to ingest: ${file.name} - ${data.error}`, 'error');
        }
    })
    .catch(error => {
        queueItem.querySelector('.status-text').innerHTML = '<i class="fas fa-times"></i> Error';
        queueItem.classList.add('error');
        addLog(`✗ Error uploading: ${file.name} - ${error.message}`, 'error');
    });
}

function addLog(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('p');
    logEntry.className = `log-entry ${type}`;
    logEntry.textContent = `[${timestamp}] ${message}`;
    logOutput.appendChild(logEntry);
    logOutput.scrollTop = logOutput.scrollHeight;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// Clear log
document.getElementById('clear-log-btn').addEventListener('click', function() {
    logOutput.innerHTML = '<p class="log-entry info">Log cleared.</p>';
});
</script>
{% endblock %}
