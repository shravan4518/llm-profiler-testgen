{% extends "base.html" %}

{% block title %}Inference - Profiler Agentic Automation{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div>
            <h1><i class="fas fa-magic"></i> Test Case & Script Generation</h1>
            <p>Generate comprehensive test cases using AI-powered intelligent retrieval</p>
        </div>
        <a href="{{ url_for('index') }}" class="btn btn-secondary btn-small">
            <i class="fas fa-arrow-left"></i> Back to Home
        </a>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <button class="tab-btn active" data-tab="generator">
            <i class="fas fa-plus-circle"></i> New Generation
        </button>
        <button class="tab-btn" data-tab="jobs">
            <i class="fas fa-list"></i> Jobs <span id="jobs-badge" class="badge">0</span>
        </button>
        <button class="tab-btn" data-tab="framework">
            <i class="fas fa-code"></i> Framework Setup & Custom Generation
        </button>
    </div>

    <!-- Generator Tab -->
    <div id="generator-tab" class="tab-content active">
        <div class="generator-section">
            <form id="generation-form">
                <div class="form-group">
                    <label for="user-prompt">
                        <i class="fas fa-keyboard"></i> Feature / Requirement Description
                    </label>
                    <textarea
                        id="user-prompt"
                        class="form-textarea"
                        rows="5"
                        placeholder="Enter feature name, API endpoint, workflow, or any test requirement&#10;Example: 'Profiler Configuration' or 'Agentless Host Checker with Profiler'"
                        required
                    ></textarea>
                    <small class="form-help">Describe the feature you want to generate test cases for</small>
                </div>

                <div class="form-group">
                    <label for="output-format">
                        <i class="fas fa-file-export"></i> Output Format
                    </label>
                    <select id="output-format" class="form-select" multiple size="3">
                        <option value="json" selected>JSON</option>
                        <option value="markdown" selected>Markdown</option>
                        <option value="excel">Excel</option>
                    </select>
                    <small class="form-help">Hold Ctrl/Cmd to select multiple formats</small>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="use-iteration">
                        <span>Use Iterative Refinement (slower but higher quality)</span>
                    </label>
                </div>

                <!-- Target System Configuration -->
                <div class="form-group config-section">
                    <div class="config-header" onclick="toggleConfig()">
                        <h3><i class="fas fa-cog"></i> Target System Configuration</h3>
                        <i class="fas fa-chevron-down" id="config-toggle-icon"></i>
                    </div>
                    <div id="config-panel" class="config-panel" style="display: none;">
                        <small class="form-help" style="display: block; margin-bottom: 1rem;">
                            Configure the target system (Profiler/IPS) for script generation
                        </small>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="target-url">
                                    <i class="fas fa-link"></i> Target URL
                                </label>
                                <input
                                    type="url"
                                    id="target-url"
                                    class="form-input"
                                    placeholder="https://profiler.example.com"
                                />
                                <small class="form-help">URL of your Profiler/IPS instance</small>
                            </div>

                            <div class="form-group">
                                <label for="target-browser">
                                    <i class="fas fa-browser"></i> Browser
                                </label>
                                <select id="target-browser" class="form-select">
                                    <option value="chromium">Chromium</option>
                                    <option value="firefox">Firefox</option>
                                    <option value="webkit">WebKit</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="target-username">
                                    <i class="fas fa-user"></i> Username
                                </label>
                                <input
                                    type="text"
                                    id="target-username"
                                    class="form-input"
                                    placeholder="admin"
                                />
                            </div>

                            <div class="form-group">
                                <label for="target-password">
                                    <i class="fas fa-lock"></i> Password
                                </label>
                                <input
                                    type="password"
                                    id="target-password"
                                    class="form-input"
                                    placeholder="••••••••"
                                />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="target-env">
                                <i class="fas fa-server"></i> Environment
                            </label>
                            <select id="target-env" class="form-select">
                                <option value="dev">Development</option>
                                <option value="staging">Staging</option>
                                <option value="production">Production</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-large" id="generate-btn">
                    <i class="fas fa-magic"></i> Generate Test Cases
                </button>
            </form>

            <!-- Generation Progress -->
            <div id="generation-progress" style="display: none;">
                <div class="progress-container">
                    <div class="progress-header">
                        <h3><i class="fas fa-spinner fa-spin"></i> Generating Test Cases...</h3>
                        <span id="progress-step">Initializing...</span>
                    </div>
                    <div class="progress-bar-container">
                        <div id="progress-bar" class="progress-bar-fill" style="width: 0%">0%</div>
                    </div>
                    <div id="generation-log" class="log-output"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Jobs Tab -->
    <div id="jobs-tab" class="tab-content">
        <div class="jobs-section">
            <div class="jobs-header">
                <h2><i class="fas fa-briefcase"></i> Generation Jobs</h2>
                <button class="btn btn-small btn-secondary" id="refresh-jobs">
                    <i class="fas fa-sync"></i> Refresh
                </button>
            </div>

            <div id="jobs-list" class="jobs-list">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Loading jobs...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Framework Setup & Custom Generation Tab -->
    <div id="framework-tab" class="tab-content">
        <div class="framework-section">
            <!-- Framework Selection - FIRST -->
            <div class="framework-selection-section">
                <h2><i class="fas fa-code-branch"></i> Select Test Framework</h2>
                <p class="section-description">Choose the framework for viewing files and generating test scripts</p>

                <div class="framework-selector">
                    <label class="framework-option">
                        <input type="radio" name="framework-type" value="pstaff" checked>
                        <div class="framework-card">
                            <div class="framework-card-header">
                                <i class="fas fa-robot"></i>
                                <strong>PSTAFF Framework</strong>
                            </div>
                            <p class="framework-card-description">
                                Robot Framework + Python (aut-pstaf)<br>
                                <small>Test suite + Python methods + Data file</small>
                            </p>
                        </div>
                    </label>
                    <label class="framework-option">
                        <input type="radio" name="framework-type" value="client">
                        <div class="framework-card">
                            <div class="framework-card-header">
                                <i class="fas fa-flask"></i>
                                <strong>Client Framework</strong>
                            </div>
                            <p class="framework-card-description">
                                pytest + PPS modules (aut-pypdc)<br>
                                <small>TestSuite + Test runner + Data file</small>
                            </p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Framework Files Section -->
            <div class="framework-upload-section">
                <h2><i class="fas fa-folder-open"></i> Available Framework Files</h2>
                <p class="section-description" id="framework-files-description">Framework files loaded from PSTAF_FRAMEWORK/aut-pstaf/PSTAF_Framework directory</p>

                <div class="upload-area">
                    <div class="upload-controls">
                        <button class="btn btn-secondary" id="refresh-framework-files">
                            <i class="fas fa-sync"></i> Refresh List
                        </button>
                    </div>

                    <div id="framework-files-list" class="framework-files-list">
                        <div class="loading-spinner">
                            <div class="spinner"></div>
                            <p>Loading framework files...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Framework File Upload Section -->
            <div class="framework-ingest-section">
                <h2><i class="fas fa-upload"></i> Upload Framework Files</h2>
                <p class="section-description">Upload Python files to enhance the selected framework's knowledge base</p>

                <div class="upload-area">
                    <div class="file-drop-zone" id="framework-drop-zone">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Drag & drop Python files here or click to browse</p>
                        <input type="file" id="framework-file-input" multiple accept=".py" hidden>
                        <button type="button" class="btn btn-secondary" id="browse-framework-files">
                            <i class="fas fa-folder-open"></i> Browse Files
                        </button>
                    </div>

                    <div id="framework-upload-queue" class="upload-queue" style="display: none;">
                        <h4><i class="fas fa-list"></i> Files to Upload</h4>
                        <div id="framework-upload-list"></div>
                        <div class="upload-actions">
                            <button type="button" class="btn btn-primary" id="ingest-framework-files">
                                <i class="fas fa-brain"></i> Ingest into Framework Expert
                            </button>
                            <button type="button" class="btn btn-secondary" id="clear-framework-queue">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>

                    <div id="framework-ingest-status" class="ingest-status" style="display: none;">
                        <div class="status-message"></div>
                    </div>
                </div>

                <!-- Knowledge Base Stats -->
                <div class="knowledge-stats" id="framework-knowledge-stats">
                    <h4><i class="fas fa-database"></i> Framework Knowledge Base</h4>
                    <div class="stats-content">
                        <span class="stat-item"><i class="fas fa-code"></i> Classes: <span id="kb-classes-count">-</span></span>
                        <span class="stat-item"><i class="fas fa-sitemap"></i> Patterns: <span id="kb-patterns-count">-</span></span>
                        <span class="stat-item"><i class="fas fa-file-code"></i> File: <span id="kb-file-name">-</span></span>
                    </div>
                    <div class="knowledge-actions">
                        <button type="button" class="btn btn-small btn-secondary" id="refresh-knowledge-stats">
                            <i class="fas fa-sync"></i> Refresh Stats
                        </button>
                        <button type="button" class="btn btn-small btn-primary" id="analyze-framework-btn">
                            <i class="fas fa-brain"></i> Analyze Existing Files
                        </button>
                        <button type="button" class="btn btn-small btn-warning" id="reanalyze-framework-btn" style="display: none;">
                            <i class="fas fa-redo"></i> Re-analyze (Force)
                        </button>
                    </div>
                    <div id="analyze-status" class="analyze-status" style="display: none;"></div>
                    <p class="help-text" id="kb-help-text">
                        <i class="fas fa-info-circle"></i> Click "Analyze Existing Files" to process all framework files shown above into the knowledge base.
                    </p>
                </div>
            </div>

            <!-- Custom Test Script Generation Section -->
            <div class="custom-generation-section">
                <h2><i class="fas fa-magic"></i> Custom Test Script Generation</h2>
                <p class="section-description">Generate a test script for a simple test case using the selected framework</p>

                <form id="custom-generation-form">
                    <div class="form-group">
                        <label for="custom-test-description">
                            <i class="fas fa-keyboard"></i> Test Case Description
                        </label>
                        <textarea
                            id="custom-test-description"
                            class="form-textarea"
                            rows="6"
                            placeholder="Describe your test case in simple terms. Example:&#10;&#10;Test Case: Verify admin login functionality&#10;Steps:&#10;1. Navigate to admin URL&#10;2. Enter admin credentials&#10;3. Click login button&#10;4. Verify successful login"
                            required
                        ></textarea>
                        <small class="form-help">The AI will generate a framework-compliant test script based on your description</small>
                    </div>

                    <div class="form-group">
                        <label for="custom-test-name">
                            <i class="fas fa-tag"></i> Test Method Name
                        </label>
                        <input
                            type="text"
                            id="custom-test-name"
                            class="form-input"
                            placeholder="test_admin_login_functionality"
                            pattern="test_[a-zA-Z0-9_]+"
                            required
                        >
                        <small class="form-help">Must start with 'test_' and use snake_case</small>
                    </div>

                    <button type="submit" class="btn btn-primary btn-large" id="generate-custom-script-btn">
                        <i class="fas fa-code"></i> Generate Test Script
                    </button>
                </form>

                <!-- Generated Script Display -->
                <div id="custom-script-result" class="script-result" style="display: none;">
                    <h3><i class="fas fa-file-code"></i> Generated Test Files</h3>
                    <div class="script-actions">
                        <button class="btn btn-small btn-secondary" id="copy-all-files">
                            <i class="fas fa-copy"></i> Copy All Files
                        </button>
                        <button class="btn btn-small btn-secondary" id="download-all-files">
                            <i class="fas fa-download"></i> Download All Files
                        </button>
                    </div>

                    <!-- File Tabs -->
                    <div class="file-tabs">
                        <button class="file-tab active" data-file="robot">
                            <i class="fas fa-robot"></i> <span id="robot-filename">Feature.robot</span>
                        </button>
                        <button class="file-tab" data-file="python">
                            <i class="fas fa-code"></i> <span id="python-filename">Feature.py</span>
                        </button>
                        <button class="file-tab" data-file="data">
                            <i class="fas fa-database"></i> <span id="data-filename">Feature_Data.py</span>
                        </button>
                        <button class="file-tab" data-file="feedback">
                            <i class="fas fa-chart-line"></i> Analysis & Feedback
                        </button>
                    </div>

                    <!-- File Content -->
                    <div class="file-content-container">
                        <div id="robot-content" class="file-content active">
                            <pre><code class="language-robot"></code></pre>
                        </div>
                        <div id="python-content" class="file-content">
                            <pre><code class="language-python"></code></pre>
                        </div>
                        <div id="data-content" class="file-content">
                            <pre><code class="language-python"></code></pre>
                        </div>
                        <div id="feedback-content" class="file-content feedback-container">
                            <!-- Feedback will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Job Details Modal -->
    <div id="job-details-modal" class="modal" style="display: none;">
        <div class="modal-content large">
            <div class="modal-header">
                <h2><i class="fas fa-file-alt"></i> Job Details</h2>
                <button class="modal-close" id="close-modal">&times;</button>
            </div>
            <div class="modal-body" id="job-details-content">
                <!-- Job details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<style>
/* Tab Navigation */
.tab-navigation {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 2rem;
    border-bottom: 2px solid #e2e8f0;
}

.tab-btn {
    background: none;
    border: none;
    padding: 1rem 2rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.tab-btn:hover {
    color: var(--primary-color);
}

.tab-btn.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.tab-btn .badge {
    background: var(--primary-color);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.85rem;
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

/* Generator Section */
.generator-section {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.form-help {
    color: var(--text-secondary);
    font-size: 0.9rem;
    margin-top: 0.25rem;
    display: block;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 500;
    cursor: pointer;
}

.checkbox-label input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.progress-container {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-top: 2rem;
}

.progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.progress-header h3 {
    color: var(--primary-color);
    margin: 0;
}

#progress-step {
    color: var(--text-secondary);
    font-size: 0.95rem;
}

/* Jobs Section */
.jobs-section {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.jobs-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.jobs-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.job-card {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
}

.job-card:hover {
    border-color: var(--primary-color);
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    transform: translateY(-2px);
}

.job-card-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 0.75rem;
}

.job-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--dark-bg);
    margin: 0;
}

.job-status {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
}

.job-status.pending {
    background: #fef3c7;
    color: #92400e;
}

.job-status.running {
    background: #dbeafe;
    color: #1e40af;
}

.job-status.completed {
    background: #d1fae5;
    color: #065f46;
}

.job-status.failed {
    background: #fee2e2;
    color: #991b1b;
}

.job-meta {
    display: flex;
    gap: 1.5rem;
    font-size: 0.9rem;
    color: var(--text-secondary);
    flex-wrap: wrap;
}

.job-meta-item {
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.script-status {
    position: absolute;
    top: 1rem;
    right: 1rem;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
}

.script-status.generated {
    background: #d1fae5;
    color: #065f46;
}

.script-status.not-generated {
    background: #e2e8f0;
    color: #64748b;
}

/* Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
}

.modal-content {
    background: white;
    border-radius: 12px;
    max-width: 900px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px rgba(0,0,0,0.2);
}

.modal-content.large {
    max-width: 1200px;
}

.modal-header {
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    background: white;
    z-index: 10;
}

.modal-header h2 {
    margin: 0;
}

.modal-close {
    background: none;
    border: none;
    font-size: 2rem;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    color: var(--danger-color);
}

.modal-body {
    padding: 2rem;
}

.job-detail-section {
    margin-bottom: 2rem;
}

.job-detail-section h3 {
    color: var(--dark-bg);
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.job-detail-content {
    background: #f8fafc;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 3px solid var(--primary-color);
    white-space: pre-wrap;
    word-wrap: break-word;
    line-height: 1.6;
}

.job-actions {
    display: flex;
    gap: 1rem;
    margin-top: 2rem;
}

/* Target System Configuration Section */
.config-section {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 0;
    margin-bottom: 1.5rem;
}

.config-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    cursor: pointer;
    user-select: none;
    transition: background-color 0.2s;
}

.config-header:hover {
    background-color: #f8fafc;
}

.config-header h3 {
    margin: 0;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.config-header i.fa-chevron-down {
    transition: transform 0.3s;
    color: var(--text-secondary);
}

.config-header.active i.fa-chevron-down {
    transform: rotate(180deg);
}

.config-panel {
    padding: 1.5rem;
    border-top: 1px solid #e2e8f0;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    font-size: 0.95rem;
    transition: border-color 0.2s, box-shadow 0.2s;
}

.form-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

/* Test Cases Table - Excel-like styling */
.test-cases-table-container {
    width: 100%;
    overflow-x: auto;
    overflow-y: auto;
    max-height: 600px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    margin-top: 1rem;
    background: white;
}

.test-cases-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
    background: white;
}

.test-cases-table thead {
    position: sticky;
    top: 0;
    background: #f8fafc;
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.test-cases-table th {
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    color: #1e293b;
    border: 1px solid #d1d5db;
    background: linear-gradient(to bottom, #f8fafc, #e2e8f0);
    white-space: nowrap;
    min-width: 120px;
}

.test-cases-table td {
    padding: 10px 16px;
    border: 1px solid #e2e8f0;
    vertical-align: top;
    background: white;
    max-width: 300px;
    word-wrap: break-word;
}

.test-cases-table tbody tr:hover {
    background: #f1f5f9;
}

.test-cases-table tbody tr:nth-child(even) {
    background: #fafbfc;
}

.test-cases-table tbody tr:nth-child(even):hover {
    background: #f1f5f9;
}

/* Script Generation Progress */
.script-generation-progress {
    padding: 2rem;
}

.script-generation-progress .progress-header {
    text-align: center;
    margin-bottom: 2rem;
}

.script-generation-progress .progress-header h3 {
    color: var(--primary-color);
    margin-bottom: 0.5rem;
}

.script-generation-progress #script-progress-message {
    color: var(--text-secondary);
    font-size: 1rem;
    margin-top: 0.5rem;
}

.progress-steps {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 2rem;
}

.progress-step {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    background: #f8fafc;
    transition: all 0.3s;
}

.progress-step i {
    font-size: 1.25rem;
    width: 24px;
    text-align: center;
}

.progress-step.pending {
    opacity: 0.5;
}

.progress-step.pending i {
    color: #94a3b8;
}

.progress-step.complete {
    background: #d1fae5;
}

.progress-step.complete i {
    color: #10b981;
}

.progress-step:not(.pending):not(.complete) i {
    color: var(--primary-color);
}

/* Column-specific styling */
.tc-id {
    font-weight: 600;
    color: #3b82f6;
    min-width: 80px;
    max-width: 100px;
    text-align: center;
    background: #eff6ff !important;
}

.tc-title {
    font-weight: 500;
    color: #1e293b;
    min-width: 200px;
    max-width: 250px;
}

.tc-category,
.tc-priority {
    text-align: center;
    min-width: 100px;
    max-width: 120px;
}

.tc-description,
.tc-prerequisites,
.tc-steps,
.tc-results,
.tc-postconditions {
    min-width: 200px;
    max-width: 350px;
    line-height: 1.5;
}

/* Badge styling for categories and priorities */
.test-cases-table .badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    white-space: nowrap;
}

.badge-functional,
.badge-medium {
    background: #dbeafe;
    color: #1e40af;
}

.badge-security,
.badge-high {
    background: #fee2e2;
    color: #991b1b;
}

.badge-performance,
.badge-critical {
    background: #fef3c7;
    color: #92400e;
}

.badge-integration,
.badge-low {
    background: #d1fae5;
    color: #065f46;
}

.badge-ui,
.badge-ux {
    background: #e9d5ff;
    color: #6b21a8;
}

.badge-api {
    background: #cffafe;
    color: #155e75;
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }

    .modal {
        padding: 1rem;
    }

    .modal-content {
        max-width: 100%;
    }

    .test-cases-table-container {
        max-height: 400px;
    }

    .test-cases-table {
        font-size: 0.75rem;
    }

    .test-cases-table th,
    .test-cases-table td {
        padding: 8px 12px;
        min-width: 100px;
    }
}

/* Framework Tab Styles */
.framework-section {
    display: flex;
    flex-direction: column;
    gap: 3rem;
}

.framework-selection-section,
.framework-upload-section,
.framework-ingest-section,
.custom-generation-section {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.framework-ingest-section {
    border: 2px dashed #e2e8f0;
    background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
}

/* File Drop Zone */
.file-drop-zone {
    border: 2px dashed #cbd5e1;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: #f8fafc;
}

.file-drop-zone:hover,
.file-drop-zone.dragover {
    border-color: var(--primary-color);
    background: #eff6ff;
}

.file-drop-zone i {
    font-size: 2.5rem;
    color: #94a3b8;
    margin-bottom: 0.5rem;
}

.file-drop-zone p {
    color: var(--text-secondary);
    margin: 0.5rem 0;
}

/* Upload Queue */
.upload-queue {
    margin-top: 1rem;
    padding: 1rem;
    background: #f8fafc;
    border-radius: 8px;
}

.upload-queue h4 {
    margin: 0 0 0.75rem 0;
    color: var(--dark-bg);
    font-size: 0.95rem;
}

.upload-queue-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.5rem;
    background: white;
    border-radius: 4px;
    margin-bottom: 0.5rem;
    border: 1px solid #e2e8f0;
}

.upload-queue-item i {
    color: var(--primary-color);
}

.upload-queue-item span {
    flex: 1;
}

.upload-queue-item .file-size {
    color: var(--text-secondary);
    font-size: 0.85rem;
    flex: none;
}

.upload-queue-item .btn-remove {
    background: none;
    border: none;
    color: #ef4444;
    cursor: pointer;
    padding: 0.25rem;
}

.upload-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
}

/* Ingest Status */
.ingest-status {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 8px;
    background: #f8fafc;
}

.ingest-status .success-message {
    color: #059669;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.ingest-status .error-message {
    color: #dc2626;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.stats-summary {
    display: flex;
    gap: 1rem;
    margin-left: auto;
    font-size: 0.9rem;
    color: var(--text-secondary);
}

/* Knowledge Stats */
.knowledge-stats {
    margin-top: 1.5rem;
    padding: 1rem;
    background: linear-gradient(135deg, #f0f7ff 0%, #f8fafc 100%);
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.knowledge-stats h4 {
    margin: 0 0 0.75rem 0;
    color: var(--dark-bg);
    font-size: 0.95rem;
}

.knowledge-stats .stats-content {
    display: flex;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin-bottom: 1rem;
}

.knowledge-stats .stat-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--text-secondary);
    font-size: 0.9rem;
}

.knowledge-stats .stat-item i {
    color: var(--primary-color);
}

.knowledge-actions {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    flex-wrap: wrap;
}

.knowledge-stats .help-text {
    margin: 0.75rem 0 0 0;
    font-size: 0.85rem;
    color: var(--text-secondary);
}

.analyze-status {
    margin-top: 0.75rem;
    padding: 0.75rem;
    border-radius: 6px;
    background: #f8fafc;
}

.btn-warning {
    background: #f59e0b;
    color: white;
}

.btn-warning:hover {
    background: #d97706;
}

.framework-selection-section {
    border: 2px solid var(--primary-color);
    background: linear-gradient(135deg, #f0f7ff 0%, #ffffff 100%);
}

/* Framework Selector */
.framework-selector {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 0.5rem;
}

.framework-option {
    cursor: pointer;
    position: relative;
}

.framework-option input[type="radio"] {
    position: absolute;
    opacity: 0;
}

.framework-card {
    background: #f8fafc;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 1.25rem;
    transition: all 0.3s;
    height: 100%;
}

.framework-option input[type="radio"]:checked + .framework-card {
    background: #eff6ff;
    border-color: var(--primary-color);
    box-shadow: 0 4px 6px rgba(59, 130, 246, 0.15);
}

.framework-option:hover .framework-card {
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.framework-card-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
    color: var(--dark-bg);
}

.framework-card-header i {
    font-size: 1.5rem;
    color: var(--primary-color);
}

.framework-card-header strong {
    font-size: 1.05rem;
}

.framework-card-description {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.95rem;
    line-height: 1.6;
}

.framework-card-description small {
    color: #94a3b8;
    font-size: 0.85rem;
}

.section-description {
    color: var(--text-secondary);
    margin-top: 0.5rem;
    margin-bottom: 1.5rem;
    line-height: 1.6;
}

.upload-area {
    margin-top: 1.5rem;
}

.upload-controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.file-upload-label {
    cursor: pointer;
}

.framework-files-list {
    background: #f8fafc;
    border: 2px dashed #cbd5e1;
    border-radius: 8px;
    padding: 1.5rem;
    min-height: 200px;
}

.framework-file-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem;
    background: white;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
    transition: all 0.2s;
}

.framework-file-item:hover {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
}

.framework-file-info {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.framework-file-icon {
    font-size: 1.5rem;
    color: var(--primary-color);
}

.framework-file-details h4 {
    margin: 0;
    color: var(--text-primary);
    font-size: 0.95rem;
    font-weight: 600;
}

.framework-file-details p {
    margin: 0.25rem 0 0 0;
    color: var(--text-secondary);
    font-size: 0.85rem;
}

.framework-file-actions {
    display: flex;
    gap: 0.5rem;
}

.script-result {
    margin-top: 2rem;
    padding: 1.5rem;
    background: #f8fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.script-result h3 {
    margin-top: 0;
    color: var(--primary-color);
}

.script-actions {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

/* File Tabs */
.file-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #e2e8f0;
}

.file-tab {
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    padding: 0.75rem 1.5rem;
    font-size: 0.95rem;
    font-weight: 600;
    color: var(--text-secondary);
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.file-tab:hover {
    color: var(--primary-color);
    background: #f8fafc;
}

.file-tab.active {
    color: var(--primary-color);
    border-bottom-color: var(--primary-color);
}

.file-tab i {
    font-size: 1rem;
}

/* File Content */
.file-content-container {
    position: relative;
}

.file-content {
    display: none;
}

.file-content.active {
    display: block;
}

/* Feedback Container Styles */
.feedback-container {
    padding: 1.5rem;
}

.feedback-section {
    background: white;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid #e2e8f0;
}

.feedback-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.rating-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    font-size: 1.5rem;
    font-weight: 700;
}

.rating-A { background: linear-gradient(135deg, #10b981, #059669); color: white; }
.rating-B { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
.rating-C { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
.rating-D { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
.rating-F { background: linear-gradient(135deg, #7f1d1d, #991b1b); color: white; }

.confidence-score {
    font-size: 1.1rem;
    color: var(--text-secondary);
}

.feedback-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.feedback-card {
    background: #f8fafc;
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid var(--primary-color);
}

.feedback-card h4 {
    margin: 0 0 0.5rem 0;
    color: var(--dark-bg);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.feedback-card .rating {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-color);
}

.strength-list, .issue-list, .recommendation-list {
    list-style: none;
    padding: 0;
    margin: 0.5rem 0;
}

.strength-list li {
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    background: #ecfdf5;
    border-left: 3px solid #10b981;
    border-radius: 4px;
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
}

.strength-list li i {
    color: #10b981;
    margin-top: 0.25rem;
}

.issue-list li {
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    background: white;
    border-left: 4px solid transparent;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.issue-critical { border-left-color: #dc2626; }
.issue-high { border-left-color: #f59e0b; }
.issue-medium { border-left-color: #3b82f6; }
.issue-low { border-left-color: #10b981; }
.issue-info { border-left-color: #64748b; }

.issue-severity {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    margin-bottom: 0.5rem;
}

.severity-critical { background: #fee2e2; color: #991b1b; }
.severity-high { background: #fef3c7; color: #92400e; }
.severity-medium { background: #dbeafe; color: #1e40af; }
.severity-low { background: #d1fae5; color: #065f46; }
.severity-info { background: #f1f5f9; color: #475569; }

.issue-location {
    font-size: 0.85rem;
    color: var(--text-secondary);
    font-style: italic;
    margin-bottom: 0.25rem;
}

.issue-text {
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.issue-suggestion {
    background: #f8fafc;
    padding: 0.5rem;
    border-radius: 4px;
    font-size: 0.9rem;
    color: var(--text-secondary);
    border-left: 2px solid var(--primary-color);
    padding-left: 0.75rem;
}

.recommendation-list li {
    padding: 0.6rem;
    margin-bottom: 0.5rem;
    background: #eff6ff;
    border-left: 3px solid #3b82f6;
    border-radius: 4px;
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
}

.recommendation-list li i {
    color: #3b82f6;
    margin-top: 0.25rem;
}

.analysis-text {
    background: #f8fafc;
    padding: 1rem;
    border-radius: 8px;
    color: var(--text-secondary);
    line-height: 1.6;
}

.script-result pre {
    background: #1e293b;
    color: #f1f5f9;
    padding: 1.5rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 0;
}

.script-result code {
    font-family: 'Courier New', monospace;
    font-size: 0.9rem;
    line-height: 1.6;
}

.empty-state {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
}

.empty-state i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.3;
}
</style>

<script>
// Toggle configuration panel
function toggleConfig() {
    const panel = document.getElementById('config-panel');
    const header = document.querySelector('.config-header');
    const icon = document.getElementById('config-toggle-icon');

    if (panel.style.display === 'none') {
        panel.style.display = 'block';
        header.classList.add('active');
    } else {
        panel.style.display = 'none';
        header.classList.remove('active');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Tab navigation
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');

    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const tabName = btn.dataset.tab;

            // Remove active from all
            tabBtns.forEach(b => b.classList.remove('active'));
            tabContents.forEach(c => c.classList.remove('active'));

            // Add active to clicked
            btn.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            // Load jobs if jobs tab
            if (tabName === 'jobs') {
                loadJobs();
            }
        });
    });

    // Load jobs initially
    loadJobs();

    // Form submission - will implement next
    const form = document.getElementById('generation-form');
    form.addEventListener('submit', handleGeneration);

    // Refresh jobs button
    document.getElementById('refresh-jobs').addEventListener('click', loadJobs);

    // Modal close
    document.getElementById('close-modal').addEventListener('click', closeModal);
});

function handleGeneration(e) {
    e.preventDefault();

    const userPrompt = document.getElementById('user-prompt').value.trim();
    const outputFormatSelect = document.getElementById('output-format');
    const useIteration = document.getElementById('use-iteration').checked;

    if (!userPrompt) {
        showToast('Please enter a feature description', 'error');
        return;
    }

    // Get selected output formats
    const outputFormats = Array.from(outputFormatSelect.selectedOptions).map(opt => opt.value);

    // Get target system configuration
    const targetConfig = {
        url: document.getElementById('target-url').value.trim() || null,
        username: document.getElementById('target-username').value.trim() || null,
        password: document.getElementById('target-password').value || null,
        browser: document.getElementById('target-browser').value,
        environment: document.getElementById('target-env').value
    };

    // Show progress
    const form = document.getElementById('generation-form');
    const progressSection = document.getElementById('generation-progress');
    const generateBtn = document.getElementById('generate-btn');
    const progressBar = document.getElementById('progress-bar');
    const progressStep = document.getElementById('progress-step');
    const generationLog = document.getElementById('generation-log');

    form.style.display = 'none';
    progressSection.style.display = 'block';
    generateBtn.disabled = true;

    progressBar.style.width = '20%';
    progressBar.textContent = '20%';
    progressStep.textContent = 'Creating job...';
    generationLog.innerHTML = '<p class="log-entry info">Initializing test case generation...</p>';

    // Call API
    fetch('/api/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            user_prompt: userPrompt,
            output_formats: outputFormats,
            use_iteration: useIteration,
            target_config: targetConfig
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            progressBar.style.width = '100%';
            progressBar.textContent = '100%';
            progressStep.textContent = 'Completed!';
            generationLog.innerHTML += `<p class="log-entry success">✓ Test cases generated successfully!</p>`;
            generationLog.innerHTML += `<p class="log-entry success">Job ID: ${data.job_id}</p>`;

            showToast('Test cases generated successfully!', 'success');

            // Switch to jobs tab after 2 seconds
            setTimeout(() => {
                document.querySelector('[data-tab="jobs"]').click();
                form.style.display = 'block';
                progressSection.style.display = 'none';
                generateBtn.disabled = false;
                progressBar.style.width = '0%';
                document.getElementById('user-prompt').value = '';
            }, 2000);
        } else {
            progressBar.style.width = '100%';
            progressBar.style.backgroundColor = '#ef4444';
            progressBar.textContent = 'Failed';
            progressStep.textContent = 'Generation failed';
            generationLog.innerHTML += `<p class="log-entry error">✗ Error: ${data.error}</p>`;

            showToast('Generation failed: ' + data.error, 'error');

            // Reset after 3 seconds
            setTimeout(() => {
                form.style.display = 'block';
                progressSection.style.display = 'none';
                generateBtn.disabled = false;
                progressBar.style.width = '0%';
                progressBar.style.backgroundColor = '';
            }, 3000);
        }
    })
    .catch(error => {
        console.error('Generation error:', error);
        progressBar.style.width = '100%';
        progressBar.style.backgroundColor = '#ef4444';
        progressBar.textContent = 'Error';
        progressStep.textContent = 'Request failed';
        generationLog.innerHTML += `<p class="log-entry error">✗ Error: ${error.message}</p>`;

        showToast('Error: ' + error.message, 'error');

        // Reset after 3 seconds
        setTimeout(() => {
            form.style.display = 'block';
            progressSection.style.display = 'none';
            generateBtn.disabled = false;
            progressBar.style.width = '0%';
            progressBar.style.backgroundColor = '';
        }, 3000);
    });
}

function loadJobs() {
    console.log('loadJobs() called');
    const jobsList = document.getElementById('jobs-list');
    if (!jobsList) {
        console.error('jobs-list element not found!');
        return;
    }

    jobsList.innerHTML = `
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading jobs...</p>
        </div>
    `;

    fetch('/api/jobs')
        .then(response => response.json())
        .then(data => {
            console.log('Jobs API response:', data);
            console.log('Number of jobs:', data.jobs.length);
            displayJobs(data.jobs);
            document.getElementById('jobs-badge').textContent = data.jobs.length;
        })
        .catch(error => {
            console.error('Error loading jobs:', error);
            jobsList.innerHTML = `
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Error loading jobs: ${error.message}</span>
                </div>
            `;
        });
}

function displayJobs(jobs) {
    console.log('displayJobs() called with', jobs.length, 'jobs');
    const jobsList = document.getElementById('jobs-list');

    if (jobs.length === 0) {
        console.log('No jobs to display');
        jobsList.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-briefcase"></i>
                <h3>No Jobs Yet</h3>
                <p>Generate your first test cases to create a job</p>
            </div>
        `;
        return;
    }

    console.log('Rendering', jobs.length, 'job cards');
    jobsList.innerHTML = jobs.map(job => `
        <div class="job-card" onclick="viewJobDetails('${job.job_id}')">
            <div class="job-card-header">
                <h3 class="job-title">${escapeHtml(job.user_prompt)}</h3>
                <span class="job-status ${job.status}">${job.status.toUpperCase()}</span>
            </div>
            <div class="job-meta">
                <span class="job-meta-item">
                    <i class="fas fa-calendar"></i>
                    ${new Date(job.created_at).toLocaleString()}
                </span>
                <span class="job-meta-item">
                    <i class="fas fa-brain"></i>
                    ${job.model}
                </span>
                <span class="job-meta-item">
                    <i class="fas fa-code"></i>
                    Script: ${job.script_status === 'generated' ? 'Generated' : 'Not Generated'}
                </span>
            </div>
        </div>
    `).join('');
}

function viewJobDetails(jobId) {
    const modal = document.getElementById('job-details-modal');
    const modalContent = document.getElementById('job-details-content');

    // Show loading
    modalContent.innerHTML = `
        <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Loading job details...</p>
        </div>
    `;
    modal.style.display = 'flex';

    // Fetch job details
    fetch(`/api/jobs/${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const job = data.job;
                modalContent.innerHTML = renderJobDetails(job);
            } else {
                modalContent.innerHTML = `
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-circle"></i>
                        <span>Error loading job: ${data.error}</span>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading job details:', error);
            modalContent.innerHTML = `
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Error: ${error.message}</span>
                </div>
            `;
        });
}

function parseTestCasesToTable(testCasesText) {
    // Parse test cases from text format to table HTML
    const testCases = [];
    // Handle both #### TC_001 (markdown heading) and **TC_001** (bold) formats
    const tcPattern = /(?:####\s*TC_\d+|\*\*TC_\d+\*\*)/g;
    const tcBlocks = testCasesText.split(tcPattern).filter(block => block.trim());

    tcBlocks.forEach((block, index) => {
        const tc = {
            id: `TC_${String(index + 1).padStart(3, '0')}`,
            title: '',
            category: '',
            priority: '',
            description: '',
            prerequisites: '',
            testData: '',
            testSteps: '',
            expectedResults: '',
            postconditions: ''
        };

        // Extract fields using regex
        const titleMatch = block.match(/\*\*Test Title:\*\*\s*(.+?)(?=\*\*|$)/s);
        if (titleMatch) tc.title = titleMatch[1].trim();

        const categoryMatch = block.match(/\*\*Category:\*\*\s*(.+?)(?=\*\*|$)/s);
        if (categoryMatch) tc.category = categoryMatch[1].trim();

        const priorityMatch = block.match(/\*\*Priority:\*\*\s*(.+?)(?=\*\*|$)/s);
        if (priorityMatch) tc.priority = priorityMatch[1].trim();

        const descMatch = block.match(/\*\*Description:\*\*\s*(.+?)(?=\*\*|$)/s);
        if (descMatch) tc.description = descMatch[1].trim();

        const preReqMatch = block.match(/\*\*Prerequisites:\*\*\s*(.+?)(?=\*\*|$)/s);
        if (preReqMatch) tc.prerequisites = preReqMatch[1].trim();

        const testDataMatch = block.match(/\*\*Test Data:\*\*\s*(.+?)(?=\*\*|$)/s);
        if (testDataMatch) tc.testData = testDataMatch[1].trim();

        const stepsMatch = block.match(/\*\*Test Steps:\*\*\s*(.+?)(?=\*\*|$)/s);
        if (stepsMatch) tc.testSteps = stepsMatch[1].trim();

        const resultsMatch = block.match(/\*\*Expected Results:\*\*\s*(.+?)(?=\*\*|$)/s);
        if (resultsMatch) tc.expectedResults = resultsMatch[1].trim();

        const postCondMatch = block.match(/\*\*Postconditions:\*\*\s*(.+?)(?=\*\*|$)/s);
        if (postCondMatch) tc.postconditions = postCondMatch[1].trim();

        testCases.push(tc);
    });

    // Generate table HTML
    let tableHtml = `
        <div class="test-cases-table-container">
            <table class="test-cases-table">
                <thead>
                    <tr>
                        <th>Test ID</th>
                        <th>Title</th>
                        <th>Category</th>
                        <th>Priority</th>
                        <th>Description</th>
                        <th>Prerequisites</th>
                        <th>Test Steps</th>
                        <th>Expected Results</th>
                        <th>Postconditions</th>
                    </tr>
                </thead>
                <tbody>
    `;

    testCases.forEach(tc => {
        const categoryClass = tc.category.toLowerCase();
        const priorityClass = tc.priority.toLowerCase();

        tableHtml += `
            <tr>
                <td class="tc-id">${escapeHtml(tc.id)}</td>
                <td class="tc-title">${escapeHtml(tc.title)}</td>
                <td class="tc-category"><span class="badge badge-${categoryClass}">${escapeHtml(tc.category)}</span></td>
                <td class="tc-priority"><span class="badge badge-${priorityClass}">${escapeHtml(tc.priority)}</span></td>
                <td class="tc-description">${escapeHtml(tc.description)}</td>
                <td class="tc-prerequisites">${escapeHtml(tc.prerequisites)}</td>
                <td class="tc-steps">${escapeHtml(tc.testSteps).replace(/\n/g, '<br>')}</td>
                <td class="tc-results">${escapeHtml(tc.expectedResults).replace(/\n/g, '<br>')}</td>
                <td class="tc-postconditions">${escapeHtml(tc.postconditions)}</td>
            </tr>
        `;
    });

    tableHtml += `
                </tbody>
            </table>
        </div>
    `;

    return tableHtml;
}

function renderJobDetails(job) {
    let html = `
        <div class="job-detail-section">
            <h3><i class="fas fa-info-circle"></i> Job Information</h3>
            <div class="job-detail-content">
                <strong>Job ID:</strong> ${job.job_id}<br>
                <strong>Status:</strong> <span class="job-status ${job.status}">${job.status.toUpperCase()}</span><br>
                <strong>Created:</strong> ${new Date(job.created_at).toLocaleString()}<br>
                <strong>Updated:</strong> ${new Date(job.updated_at).toLocaleString()}<br>
                <strong>Model:</strong> ${job.model}<br>
                <strong>Iterative Refinement:</strong> ${job.parameters?.use_iteration ? 'Yes' : 'No'}
            </div>
        </div>

        <div class="job-detail-section">
            <h3><i class="fas fa-keyboard"></i> User Prompt</h3>
            <div class="job-detail-content">${escapeHtml(job.user_prompt)}</div>
        </div>
    `;

    if (job.status === 'completed') {
        // Test Plan
        if (job.test_plan) {
            html += `
                <div class="job-detail-section">
                    <h3><i class="fas fa-clipboard-list"></i> Test Plan</h3>
                    <div class="job-detail-content">${escapeHtml(job.test_plan)}</div>
                </div>
            `;
        }

        // Test Cases
        if (job.test_cases) {
            html += `
                <div class="job-detail-section">
                    <h3><i class="fas fa-file-alt"></i> Test Cases</h3>
                    ${parseTestCasesToTable(job.test_cases)}
                </div>
            `;
        }

        // Validation Report
        if (job.validation_report) {
            html += `
                <div class="job-detail-section">
                    <h3><i class="fas fa-check-circle"></i> Validation Report</h3>
                    <div class="job-detail-content">${escapeHtml(job.validation_report)}</div>
                </div>
            `;
        }

        // Output Files
        if (job.output_files && Object.keys(job.output_files).length > 0) {
            html += `
                <div class="job-detail-section">
                    <h3><i class="fas fa-download"></i> Output Files</h3>
                    <div class="job-detail-content">
                        ${Object.entries(job.output_files).map(([format, path]) =>
                            `<strong>${format.toUpperCase()}:</strong> ${path}<br>`
                        ).join('')}
                    </div>
                </div>
            `;
        }

        // Metadata
        if (job.metadata) {
            html += `
                <div class="job-detail-section">
                    <h3><i class="fas fa-info"></i> Metadata</h3>
                    <div class="job-detail-content">
                        <strong>Feature:</strong> ${job.metadata.feature_name || 'N/A'}<br>
                        <strong>Intent:</strong> ${job.metadata.intent || 'N/A'}<br>
                        <strong>Sources:</strong> ${job.metadata.sources_count || 0} documents<br>
                        <strong>Context Results:</strong> ${job.metadata.rag_results_count || 0} chunks
                    </div>
                </div>
            `;
        }

        // Script Generation Section
        html += `
            <div class="job-detail-section">
                <h3><i class="fas fa-code"></i> Script Generation</h3>
                <div class="job-detail-content">
                    <strong>Status:</strong> <span class="script-status ${job.script_status}">${job.script_status.replace('_', ' ').toUpperCase()}</span>
                </div>
                <div class="job-actions">
        `;

        if (job.script_status === 'generated') {
            html += `
                <button class="btn btn-primary" onclick="viewScript('${job.job_id}')">
                    <i class="fas fa-eye"></i> View Script
                </button>
            `;
        } else if (job.script_status === 'not_generated') {
            html += `
                <button class="btn btn-secondary" onclick="generateScriptForJob('${job.job_id}')">
                    <i class="fas fa-cog"></i> Generate Script
                </button>
            `;
        }

        html += `
                </div>
            </div>
        `;
    } else if (job.status === 'failed') {
        html += `
            <div class="job-detail-section">
                <h3><i class="fas fa-exclamation-triangle"></i> Error</h3>
                <div class="job-detail-content" style="color: #ef4444;">
                    ${escapeHtml(job.error || 'Unknown error')}
                </div>
            </div>
        `;
    } else if (job.status === 'running') {
        html += `
            <div class="job-detail-section">
                <h3><i class="fas fa-spinner fa-spin"></i> Generation in Progress</h3>
                <div class="job-detail-content">
                    Please wait while test cases are being generated...
                </div>
            </div>
        `;
    }

    return html;
}

function generateScriptForJob(jobId) {
    // Show confirmation
    if (!confirm('Generate automated test scripts for this job? This may take a few minutes.')) {
        return;
    }

    // Show progress in modal
    const modalContent = document.getElementById('job-details-content');
    const originalContent = modalContent.innerHTML;

    modalContent.innerHTML = `
        <div class="script-generation-progress">
            <div class="progress-header">
                <h3><i class="fas fa-spinner fa-spin"></i> Generating Test Scripts</h3>
                <p id="script-progress-message">Initializing script generation...</p>
            </div>
            <div class="progress-bar-container">
                <div id="script-progress-bar" class="progress-bar-fill" style="width: 10%">10%</div>
            </div>
            <div class="progress-steps">
                <div class="progress-step" id="step-parsing">
                    <i class="fas fa-circle-notch fa-spin"></i> Parsing test cases...
                </div>
                <div class="progress-step pending" id="step-framework">
                    <i class="fas fa-circle"></i> Retrieving framework code...
                </div>
                <div class="progress-step pending" id="step-config">
                    <i class="fas fa-circle"></i> Generating configuration...
                </div>
                <div class="progress-step pending" id="step-tests">
                    <i class="fas fa-circle"></i> Generating test scripts...
                </div>
                <div class="progress-step pending" id="step-docs">
                    <i class="fas fa-circle"></i> Creating documentation...
                </div>
            </div>
        </div>
    `;

    // Simulate progress updates (since we don't have real-time updates from backend)
    let progress = 10;
    const progressBar = document.getElementById('script-progress-bar');
    const progressMessage = document.getElementById('script-progress-message');

    const updateProgress = (percent, message, stepId) => {
        progress = percent;
        progressBar.style.width = `${percent}%`;
        progressBar.textContent = `${percent}%`;
        progressMessage.textContent = message;

        if (stepId) {
            // Mark previous steps as complete
            document.querySelectorAll('.progress-step').forEach(step => {
                if (step.id < stepId && !step.classList.contains('complete')) {
                    step.classList.remove('pending');
                    step.classList.add('complete');
                    step.querySelector('i').className = 'fas fa-check-circle';
                }
            });

            // Mark current step as active
            const currentStep = document.getElementById(stepId);
            if (currentStep) {
                currentStep.classList.remove('pending');
                currentStep.querySelector('i').className = 'fas fa-circle-notch fa-spin';
            }
        }
    };

    // Simulate progress stages
    setTimeout(() => updateProgress(25, 'Retrieving framework code snippets...', 'step-framework'), 1000);
    setTimeout(() => updateProgress(40, 'Generating pytest configuration...', 'step-config'), 3000);
    setTimeout(() => updateProgress(60, 'Generating test scripts...', 'step-tests'), 5000);
    setTimeout(() => updateProgress(85, 'Creating documentation files...', 'step-docs'), 8000);

    // Call API to generate scripts
    fetch(`/api/jobs/${jobId}/generate-script`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateProgress(100, 'Script generation completed!', null);

            // Mark all steps as complete
            document.querySelectorAll('.progress-step').forEach(step => {
                step.classList.remove('pending');
                step.classList.add('complete');
                step.querySelector('i').className = 'fas fa-check-circle';
            });

            progressBar.style.backgroundColor = '#10b981';

            showToast(`Scripts generated successfully! ${data.test_count} test scripts created.`, 'success');

            // Refresh job details after 2 seconds
            setTimeout(() => {
                viewJobDetails(jobId);
            }, 2000);
        } else {
            progressBar.style.backgroundColor = '#ef4444';
            progressBar.textContent = 'Failed';
            progressMessage.textContent = 'Script generation failed!';
            progressMessage.style.color = '#ef4444';

            modalContent.innerHTML += `
                <div class="alert alert-error" style="margin-top: 1rem;">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>${data.error}</span>
                </div>
                <button class="btn btn-secondary" onclick="viewJobDetails('${jobId}')" style="margin-top: 1rem;">
                    <i class="fas fa-arrow-left"></i> Back to Job Details
                </button>
            `;

            showToast('Script generation failed: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error generating scripts:', error);
        progressBar.style.backgroundColor = '#ef4444';
        progressBar.textContent = 'Error';
        progressMessage.textContent = 'Request failed!';
        progressMessage.style.color = '#ef4444';

        modalContent.innerHTML += `
            <div class="alert alert-error" style="margin-top: 1rem;">
                <i class="fas fa-exclamation-circle"></i>
                <span>${error.message}</span>
            </div>
            <button class="btn btn-secondary" onclick="viewJobDetails('${jobId}')" style="margin-top: 1rem;">
                <i class="fas fa-arrow-left"></i> Back to Job Details
            </button>
        `;

        showToast('Error: ' + error.message, 'error');
    });
}

function viewScript(jobId) {
    fetch(`/api/jobs/${jobId}/script`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.scripts) {
                    // Multiple scripts - show file list
                    const fileList = Object.keys(data.scripts).join('\n- ');
                    const message = `✓ Scripts Generated Successfully!\n\nLocation: ${data.scripts_dir}\n\nFiles (${data.file_count}):\n- ${fileList}\n\nYou can find all the generated test scripts, configuration, and documentation in the scripts directory.`;
                    alert(message);
                } else if (data.script) {
                    // Single script (legacy)
                    alert(`Script:\n\n${data.script}`);
                }
            } else {
                showToast('Error loading script: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showToast('Error: ' + error.message, 'error');
        });
}

function closeModal() {
    document.getElementById('job-details-modal').style.display = 'none';
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================================================
// Framework Tab Functionality
// ============================================================================

// Load framework files on page load
document.addEventListener('DOMContentLoaded', function() {
    loadFrameworkFiles();

    // Framework file refresh - uses current selected framework
    document.getElementById('refresh-framework-files').addEventListener('click', () => loadFrameworkFiles());

    // Custom script generation
    document.getElementById('custom-generation-form').addEventListener('submit', handleCustomScriptGeneration);
    document.getElementById('copy-all-files')?.addEventListener('click', copyAllFiles);
    document.getElementById('download-all-files')?.addEventListener('click', downloadAllFiles);

    // File tab switching
    document.querySelectorAll('.file-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const fileType = this.dataset.file;
            switchFileTab(fileType);
        });
    });

    // Framework selection change - reload files
    document.querySelectorAll('input[name="framework-type"]').forEach(radio => {
        radio.addEventListener('change', function() {
            loadFrameworkFiles(this.value);
        });
    });
});

function getSelectedFramework() {
    const selected = document.querySelector('input[name="framework-type"]:checked');
    return selected ? selected.value : 'pstaff';
}

function loadFrameworkFiles(frameworkType = null) {
    const filesList = document.getElementById('framework-files-list');
    const descriptionEl = document.getElementById('framework-files-description');

    // Use provided type or get from selection
    const fwType = frameworkType || getSelectedFramework();

    filesList.innerHTML = '<div class="loading-spinner"><div class="spinner"></div><p>Loading framework files...</p></div>';

    fetch(`/api/framework/files?framework_type=${fwType}`)
        .then(response => response.json())
        .then(data => {
            // Update description based on framework
            if (descriptionEl) {
                descriptionEl.textContent = `Framework files loaded from ${data.framework_path || 'framework directory'}`;
            }

            if (data.files && data.files.length > 0) {
                filesList.innerHTML = data.files.map(file => `
                    <div class="framework-file-item">
                        <div class="framework-file-info">
                            <i class="fas fa-file-code framework-file-icon"></i>
                            <div class="framework-file-details">
                                <h4>${escapeHtml(file.name)}</h4>
                                <p>${formatFileSize(file.size)} • Last modified: ${formatDate(file.modified)}</p>
                            </div>
                        </div>
                        <div class="framework-file-actions">
                            <span class="badge" style="background: #10b981; color: white;">
                                <i class="fas fa-check-circle"></i> Loaded
                            </span>
                        </div>
                    </div>
                `).join('');
            } else {
                const expectedPath = fwType === 'client'
                    ? 'aut-pypdc/Generic/Framework and aut-pypdc/PPS/Framework'
                    : 'PSTAF_FRAMEWORK/aut-pstaf/PSTAF_Framework';
                filesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <p>No framework files found</p>
                        <p>Expected location: ${expectedPath}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading framework files:', error);
            filesList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Error loading framework files</p>
                    <p>${error.message}</p>
                </div>
            `;
        });
}

// ============================================================================
// Framework File Upload and Ingestion
// ============================================================================

let frameworkUploadQueue = [];

function initFrameworkUpload() {
    const dropZone = document.getElementById('framework-drop-zone');
    const fileInput = document.getElementById('framework-file-input');
    const browseBtn = document.getElementById('browse-framework-files');
    const ingestBtn = document.getElementById('ingest-framework-files');
    const clearBtn = document.getElementById('clear-framework-queue');
    const refreshStatsBtn = document.getElementById('refresh-knowledge-stats');

    // Browse button
    if (browseBtn) {
        browseBtn.addEventListener('click', () => fileInput.click());
    }

    // File input change
    if (fileInput) {
        fileInput.addEventListener('change', (e) => {
            handleFrameworkFiles(e.target.files);
        });
    }

    // Drag and drop
    if (dropZone) {
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFrameworkFiles(e.dataTransfer.files);
        });

        dropZone.addEventListener('click', () => fileInput.click());
    }

    // Ingest button
    if (ingestBtn) {
        ingestBtn.addEventListener('click', ingestFrameworkFiles);
    }

    // Clear button
    if (clearBtn) {
        clearBtn.addEventListener('click', clearFrameworkQueue);
    }

    // Refresh stats button
    if (refreshStatsBtn) {
        refreshStatsBtn.addEventListener('click', loadKnowledgeStats);
    }

    // Load initial stats
    loadKnowledgeStats();

    // Update stats when framework changes
    document.querySelectorAll('input[name="framework-type"]').forEach(radio => {
        radio.addEventListener('change', loadKnowledgeStats);
    });
}

function handleFrameworkFiles(files) {
    const queueEl = document.getElementById('framework-upload-queue');
    const listEl = document.getElementById('framework-upload-list');

    for (const file of files) {
        if (file.name.endsWith('.py')) {
            frameworkUploadQueue.push(file);
        }
    }

    if (frameworkUploadQueue.length > 0) {
        queueEl.style.display = 'block';
        listEl.innerHTML = frameworkUploadQueue.map((file, index) => `
            <div class="upload-queue-item">
                <i class="fas fa-file-code"></i>
                <span>${escapeHtml(file.name)}</span>
                <span class="file-size">${formatFileSize(file.size)}</span>
                <button type="button" class="btn-remove" onclick="removeFromFrameworkQueue(${index})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }
}

function removeFromFrameworkQueue(index) {
    frameworkUploadQueue.splice(index, 1);
    const listEl = document.getElementById('framework-upload-list');
    const queueEl = document.getElementById('framework-upload-queue');

    if (frameworkUploadQueue.length === 0) {
        queueEl.style.display = 'none';
    } else {
        listEl.innerHTML = frameworkUploadQueue.map((file, idx) => `
            <div class="upload-queue-item">
                <i class="fas fa-file-code"></i>
                <span>${escapeHtml(file.name)}</span>
                <span class="file-size">${formatFileSize(file.size)}</span>
                <button type="button" class="btn-remove" onclick="removeFromFrameworkQueue(${idx})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }
}

function clearFrameworkQueue() {
    frameworkUploadQueue = [];
    document.getElementById('framework-upload-queue').style.display = 'none';
    document.getElementById('framework-upload-list').innerHTML = '';
}

async function ingestFrameworkFiles() {
    if (frameworkUploadQueue.length === 0) {
        showToast('No files to ingest', 'warning');
        return;
    }

    const frameworkType = getSelectedFramework();
    const statusEl = document.getElementById('framework-ingest-status');
    const ingestBtn = document.getElementById('ingest-framework-files');

    statusEl.style.display = 'block';
    statusEl.querySelector('.status-message').innerHTML = `
        <div class="loading-spinner" style="display: inline-flex; align-items: center; gap: 10px;">
            <div class="spinner"></div>
            <span>Ingesting ${frameworkUploadQueue.length} files into ${frameworkType.toUpperCase()} knowledge base...</span>
        </div>
    `;
    ingestBtn.disabled = true;

    const formData = new FormData();
    formData.append('framework_type', frameworkType);
    frameworkUploadQueue.forEach(file => {
        formData.append('files', file);
    });

    try {
        const response = await fetch('/api/framework/ingest-files', {
            method: 'POST',
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            statusEl.querySelector('.status-message').innerHTML = `
                <div class="success-message">
                    <i class="fas fa-check-circle"></i>
                    <span>${data.message}</span>
                    <div class="stats-summary">
                        <span>Classes: ${data.stats.classes_count}</span>
                        <span>Patterns: ${data.stats.patterns_count}</span>
                    </div>
                </div>
            `;
            showToast(data.message, 'success');
            clearFrameworkQueue();
            loadKnowledgeStats();
        } else {
            statusEl.querySelector('.status-message').innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Error: ${data.error}</span>
                </div>
            `;
            showToast('Ingestion failed: ' + data.error, 'error');
        }
    } catch (error) {
        statusEl.querySelector('.status-message').innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <span>Error: ${error.message}</span>
            </div>
        `;
        showToast('Ingestion failed: ' + error.message, 'error');
    }

    ingestBtn.disabled = false;
}

function loadKnowledgeStats() {
    const frameworkType = getSelectedFramework();
    const classesEl = document.getElementById('kb-classes-count');
    const patternsEl = document.getElementById('kb-patterns-count');
    const fileEl = document.getElementById('kb-file-name');
    const analyzeBtn = document.getElementById('analyze-framework-btn');
    const reanalyzeBtn = document.getElementById('reanalyze-framework-btn');
    const helpText = document.getElementById('kb-help-text');

    fetch(`/api/framework/knowledge-stats?framework_type=${frameworkType}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.stats) {
                const stats = data.stats;
                classesEl.textContent = stats.classes_count || '0';
                patternsEl.textContent = stats.patterns_count || '0';

                if (stats.knowledge_file) {
                    const fileName = stats.knowledge_file.split(/[/\\]/).pop();
                    fileEl.textContent = fileName;
                } else {
                    fileEl.textContent = stats.status === 'not_analyzed' ? 'Not analyzed yet' : '-';
                }

                // Show/hide buttons based on analysis status
                const isAnalyzed = stats.status === 'ready' && stats.classes_count > 0;
                if (isAnalyzed) {
                    analyzeBtn.style.display = 'none';
                    reanalyzeBtn.style.display = 'inline-flex';
                    helpText.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> Knowledge base is ready. Use "Re-analyze" to update with latest files.';
                } else {
                    analyzeBtn.style.display = 'inline-flex';
                    reanalyzeBtn.style.display = 'none';
                    helpText.innerHTML = '<i class="fas fa-info-circle"></i> Click "Analyze Existing Files" to process all framework files shown above into the knowledge base.';
                }
            } else {
                classesEl.textContent = '0';
                patternsEl.textContent = '0';
                fileEl.textContent = 'Not analyzed yet';
                analyzeBtn.style.display = 'inline-flex';
                reanalyzeBtn.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading knowledge stats:', error);
            classesEl.textContent = '-';
            patternsEl.textContent = '-';
            fileEl.textContent = 'Error loading';
        });
}

async function analyzeFramework(force = false) {
    const frameworkType = getSelectedFramework();
    const analyzeBtn = document.getElementById('analyze-framework-btn');
    const reanalyzeBtn = document.getElementById('reanalyze-framework-btn');
    const statusEl = document.getElementById('analyze-status');

    const activeBtn = force ? reanalyzeBtn : analyzeBtn;
    const originalText = activeBtn.innerHTML;

    activeBtn.disabled = true;
    activeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';

    statusEl.style.display = 'block';
    statusEl.innerHTML = `
        <div class="loading-spinner" style="display: inline-flex; align-items: center; gap: 10px;">
            <div class="spinner"></div>
            <span>Analyzing ${frameworkType.toUpperCase()} framework files... This may take a minute.</span>
        </div>
    `;

    try {
        const response = await fetch('/api/framework/analyze', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ framework_type: frameworkType, force: force })
        });

        const data = await response.json();

        if (data.success) {
            statusEl.innerHTML = `
                <div class="success-message">
                    <i class="fas fa-check-circle"></i>
                    <span>${data.message}</span>
                    <div class="stats-summary">
                        <span>Classes: ${data.stats.classes_count}</span>
                        <span>Patterns: ${data.stats.patterns_count}</span>
                    </div>
                </div>
            `;
            showToast(data.message, 'success');
            loadKnowledgeStats();
        } else {
            statusEl.innerHTML = `
                <div class="error-message">
                    <i class="fas fa-exclamation-circle"></i>
                    <span>Error: ${data.error}</span>
                </div>
            `;
            showToast('Analysis failed: ' + data.error, 'error');
        }
    } catch (error) {
        statusEl.innerHTML = `
            <div class="error-message">
                <i class="fas fa-exclamation-circle"></i>
                <span>Error: ${error.message}</span>
            </div>
        `;
        showToast('Analysis failed: ' + error.message, 'error');
    }

    activeBtn.disabled = false;
    activeBtn.innerHTML = originalText;
}

// Initialize framework upload on page load
document.addEventListener('DOMContentLoaded', function() {
    initFrameworkUpload();

    // Analyze framework buttons
    const analyzeBtn = document.getElementById('analyze-framework-btn');
    const reanalyzeBtn = document.getElementById('reanalyze-framework-btn');

    if (analyzeBtn) {
        analyzeBtn.addEventListener('click', () => analyzeFramework(false));
    }
    if (reanalyzeBtn) {
        reanalyzeBtn.addEventListener('click', () => analyzeFramework(true));
    }
});

// Global variable to store generated files
let generatedFiles = null;

function handleCustomScriptGeneration(event) {
    event.preventDefault();

    const description = document.getElementById('custom-test-description').value;
    const testName = document.getElementById('custom-test-name').value;
    const frameworkType = document.querySelector('input[name="framework-type"]:checked').value;
    const resultDiv = document.getElementById('custom-script-result');
    const generateBtn = document.getElementById('generate-custom-script-btn');

    console.log('Generating script with framework:', frameworkType);
    console.log('Description:', description);
    console.log('Test name:', testName);

    // Disable button and show loading
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

    fetch('/api/framework/generate-script', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            description: description,
            test_name: testName,
            framework_type: frameworkType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Store generated files globally
            generatedFiles = data.files;
            const featureName = data.feature_name;
            const fwType = data.framework_type || 'pstaff';

            // Update filenames in tabs based on framework type
            if (fwType === 'client') {
                // Client framework: Test runner, TestSuite, Data
                document.getElementById('robot-filename').textContent = `${featureName}_Test.py`;
                document.getElementById('python-filename').textContent = `${featureName}_TestSuite.py`;
                document.getElementById('data-filename').textContent = `${featureName}_Data.py`;
            } else {
                // PSTAFF framework: Robot, Python library, Data
                document.getElementById('robot-filename').textContent = `${featureName}.robot`;
                document.getElementById('python-filename').textContent = `${featureName}.py`;
                document.getElementById('data-filename').textContent = `${featureName}_Data.py`;
            }

            // Update file contents
            document.querySelector('#robot-content code').textContent = data.files.robot_file;
            document.querySelector('#python-content code').textContent = data.files.python_file;
            document.querySelector('#data-content code').textContent = data.files.data_file;

            // Populate feedback tab with generation feedback and code review
            populateFeedbackTab(data.generation_feedback, data.review, featureName);

            // Show result div
            resultDiv.style.display = 'block';

            // Switch to first tab (data file for client, robot for PSTAFF)
            switchFileTab(fwType === 'client' ? 'data' : 'robot');

            showToast('Test files generated successfully!', 'success');

            // Scroll to result
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            showToast('Error generating script: ' + data.error, 'error');
            console.error('Backend error:', data.error);
            resultDiv.innerHTML = `
                <div class="alert alert-error" style="display: block; margin-top: 20px;">
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Error:</strong> ${data.error}
                </div>
            `;
            resultDiv.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error generating script:', error);
        console.error('Error details:', error.message);
        showToast('Error generating script: ' + error.message, 'error');
        resultDiv.innerHTML = `
            <div class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i>
                <strong>Error:</strong> ${error.message}
            </div>
        `;
    })
    .finally(() => {
        // Re-enable button
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-code"></i> Generate Test Script';
    });
}

function switchFileTab(fileType) {
    // Remove active class from all tabs and contents
    document.querySelectorAll('.file-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.file-content').forEach(content => content.classList.remove('active'));

    // Add active class to selected tab and content
    document.querySelector(`[data-file="${fileType}"]`).classList.add('active');
    document.getElementById(`${fileType}-content`).classList.add('active');
}

function populateFeedbackTab(generationFeedback, review, featureName) {
    const feedbackContainer = document.getElementById('feedback-content');

    if (!review) {
        feedbackContainer.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-info-circle"></i>
                <p>No feedback available</p>
            </div>
        `;
        return;
    }

    // Extract rating letter (A, B, C, D, F) for CSS class
    const ratingLetter = review.overall_rating ? review.overall_rating.charAt(0) : 'C';

    let html = `
        <!-- Overall Rating Section -->
        <div class="feedback-section">
            <div class="feedback-header">
                <div class="rating-badge rating-${ratingLetter}">
                    <i class="fas fa-award"></i>
                    <span>${escapeHtml(review.overall_rating || 'N/A')}</span>
                </div>
                <div class="confidence-score">
                    <i class="fas fa-gauge-high"></i> Confidence: ${review.confidence_score || 0}%
                </div>
            </div>
            ${review.rating_explanation ? `
                <div style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border-left: 4px solid var(--primary-color); border-radius: 4px;">
                    <strong style="color: var(--dark-bg);">Why this rating?</strong>
                    <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">${escapeHtml(review.rating_explanation)}</p>
                </div>
            ` : ''}
            ${review.what_would_make_it_A ? `
                <div style="margin-top: 0.75rem; padding: 1rem; background: #ecfdf5; border-left: 4px solid #10b981; border-radius: 4px;">
                    <strong style="color: #065f46;"><i class="fas fa-arrow-up"></i> How to reach Grade A</strong>
                    <p style="margin: 0.5rem 0 0 0; color: #047857;">${escapeHtml(review.what_would_make_it_A)}</p>
                </div>
            ` : ''}
        </div>
    `;

    // Top 3 Priorities Section (MOST IMPORTANT - SHOW FIRST)
    if (review.top_3_priorities && review.top_3_priorities.length > 0) {
        html += `
            <div class="feedback-section" style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b;">
                <h3 style="color: #92400e;"><i class="fas fa-bullseye"></i> Top Priority Actions</h3>
                <p style="color: #78350f; margin-bottom: 1rem;">Fix these issues first for maximum impact</p>
        `;

        review.top_3_priorities.forEach((priority, index) => {
            const priorityNumber = index + 1;
            html += `
                <div style="background: white; padding: 1rem; margin-bottom: 0.75rem; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span style="background: #f59e0b; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem;">${priorityNumber}</span>
                        <strong style="color: var(--dark-bg); font-size: 1.05rem;">${escapeHtml(priority.issue)}</strong>
                        ${priority.estimated_effort ? `<span class="badge" style="background: #dbeafe; color: #1e40af; margin-left: auto;"><i class="fas fa-clock"></i> ${escapeHtml(priority.estimated_effort)}</span>` : ''}
                    </div>
                    <div style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                        <strong style="color: var(--text-primary);">Why:</strong> ${escapeHtml(priority.why)}
                    </div>
                    ${priority.impact_if_not_fixed ? `
                        <div style="background: #fee2e2; padding: 0.5rem; border-radius: 4px; margin-bottom: 0.5rem;">
                            <strong style="color: #991b1b;"><i class="fas fa-exclamation-triangle"></i> Impact if ignored:</strong>
                            <span style="color: #7f1d1d;"> ${escapeHtml(priority.impact_if_not_fixed)}</span>
                        </div>
                    ` : ''}
                    ${priority.how_to_fix ? `
                        <div style="background: #eff6ff; padding: 0.5rem; border-radius: 4px;">
                            <strong style="color: #1e40af;"><i class="fas fa-wrench"></i> How to fix:</strong>
                            <span style="color: #1e3a8a;"> ${escapeHtml(priority.how_to_fix)}</span>
                        </div>
                    ` : ''}
                </div>
            `;
        });

        html += `</div>`;
    }

    // File Ratings Grid
    html += `
        <div class="feedback-section">
            <h3><i class="fas fa-file-code"></i> Individual File Ratings</h3>
            <div class="feedback-grid">
    `;

    // File ratings
    if (review.file_ratings) {
        const fileNames = {
            robot_file: `${featureName}.robot`,
            python_file: `${featureName}.py`,
            data_file: `${featureName}_Data.py`
        };

        for (const [fileKey, rating] of Object.entries(review.file_ratings)) {
            const fileName = fileNames[fileKey] || fileKey;
            const fileLetter = rating ? rating.charAt(0) : 'C';
            html += `
                <div class="feedback-card">
                    <h4>${escapeHtml(fileName)}</h4>
                    <div class="rating rating-${fileLetter}">${escapeHtml(rating)}</div>
                </div>
            `;
        }
    }

    html += `
            </div>
        </div>
    `;

    // Generation Feedback Section
    if (generationFeedback) {
        html += `
            <div class="feedback-section">
                <h3><i class="fas fa-lightbulb"></i> Generation Insights</h3>
                <div class="feedback-card" style="border-left-color: #3b82f6;">
                    <h4>Overall Confidence</h4>
                    <div class="rating" style="color: #3b82f6;">${generationFeedback.overall_confidence || 0}%</div>
                </div>
        `;

        // Assumptions
        if (generationFeedback.assumptions && generationFeedback.assumptions.length > 0) {
            html += `
                <h4 style="margin-top: 1rem; color: var(--text-primary);">
                    <i class="fas fa-question-circle"></i> Assumptions Made
                </h4>
                <ul class="recommendation-list">
            `;
            generationFeedback.assumptions.forEach(assumption => {
                html += `
                    <li>
                        <i class="fas fa-info-circle"></i>
                        <div>
                            <strong>${escapeHtml(assumption.description || assumption)}</strong>
                            ${assumption.reason ? `<br><small style="color: var(--text-secondary);">Reason: ${escapeHtml(assumption.reason)}</small>` : ''}
                            ${assumption.confidence ? `<br><small style="color: var(--text-secondary);">Confidence: ${assumption.confidence}%</small>` : ''}
                        </div>
                    </li>
                `;
            });
            html += `</ul>`;
        }

        // Uncertainties
        if (generationFeedback.uncertainties && generationFeedback.uncertainties.length > 0) {
            html += `
                <h4 style="margin-top: 1rem; color: var(--text-primary);">
                    <i class="fas fa-exclamation-triangle"></i> Uncertainties
                </h4>
                <ul class="issue-list">
            `;
            generationFeedback.uncertainties.forEach(uncertainty => {
                html += `
                    <li class="issue-medium">
                        <span class="issue-severity severity-medium">Uncertain</span>
                        <div class="issue-text">${escapeHtml(uncertainty)}</div>
                    </li>
                `;
            });
            html += `</ul>`;
        }

        html += `</div>`;
    }

    // Strengths Section
    if (review.strengths && review.strengths.length > 0) {
        html += `
            <div class="feedback-section">
                <h3><i class="fas fa-check-circle" style="color: #10b981;"></i> Strengths</h3>
                <ul class="strength-list">
        `;
        review.strengths.forEach(strength => {
            html += `
                <li>
                    <i class="fas fa-check"></i>
                    <span>${escapeHtml(strength)}</span>
                </li>
            `;
        });
        html += `
                </ul>
            </div>
        `;
    }

    // Test Coverage Gaps Section
    if (review.test_coverage_gaps) {
        const gaps = review.test_coverage_gaps;
        html += `
            <div class="feedback-section">
                <h3><i class="fas fa-shield-halved" style="color: #f59e0b;"></i> Test Coverage Analysis</h3>
                ${gaps.requirement_coverage_percent !== undefined ? `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <strong>Requirement Coverage</strong>
                            <span style="font-size: 1.2rem; font-weight: 700; color: ${gaps.requirement_coverage_percent >= 80 ? '#10b981' : gaps.requirement_coverage_percent >= 60 ? '#f59e0b' : '#ef4444'};">${gaps.requirement_coverage_percent}%</span>
                        </div>
                        <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="background: ${gaps.requirement_coverage_percent >= 80 ? '#10b981' : gaps.requirement_coverage_percent >= 60 ? '#f59e0b' : '#ef4444'}; height: 100%; width: ${gaps.requirement_coverage_percent}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                ` : ''}
                ${gaps.what_is_missing ? `
                    <div style="background: #fef3c7; padding: 0.75rem; border-radius: 4px; border-left: 4px solid #f59e0b; margin-bottom: 1rem;">
                        <strong style="color: #92400e;">Missing:</strong> <span style="color: #78350f;">${escapeHtml(gaps.what_is_missing)}</span>
                    </div>
                ` : ''}
                ${gaps.missing_scenarios && gaps.missing_scenarios.length > 0 ? `
                    <div style="margin-bottom: 1rem;">
                        <strong style="color: var(--dark-bg);">Missing Test Scenarios:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--text-secondary);">
                            ${gaps.missing_scenarios.map(scenario => `<li>${escapeHtml(scenario)}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
                ${gaps.untested_conditions && gaps.untested_conditions.length > 0 ? `
                    <div>
                        <strong style="color: var(--dark-bg);">Untested Conditions:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem; color: var(--text-secondary);">
                            ${gaps.untested_conditions.map(condition => `<li>${escapeHtml(condition)}</li>`).join('')}
                        </ul>
                    </div>
                ` : ''}
            </div>
        `;
    }

    // Potential Issues Section (Enhanced with effort and impact)
    if (review.potential_issues && review.potential_issues.length > 0) {
        html += `
            <div class="feedback-section">
                <h3><i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> All Potential Issues</h3>
                <ul class="issue-list">
        `;
        review.potential_issues.forEach(issue => {
            const severity = issue.severity || 'info';
            const severityClass = `severity-${severity}`;
            const issueClass = `issue-${severity}`;

            html += `
                <li class="${issueClass}">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <span class="issue-severity ${severityClass}">${escapeHtml(severity.toUpperCase())}</span>
                        ${issue.estimated_effort ? `<span class="badge" style="background: #dbeafe; color: #1e40af;"><i class="fas fa-clock"></i> ${escapeHtml(issue.estimated_effort)}</span>` : ''}
                    </div>
                    ${issue.file ? `<div class="issue-location">📁 ${escapeHtml(issue.file)}${issue.location ? ` • ${escapeHtml(issue.location)}` : ''}</div>` : ''}
                    <div class="issue-text">${escapeHtml(issue.issue || issue)}</div>
                    ${issue.impact_if_not_fixed ? `
                        <div style="background: #fef3c7; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; border-left: 3px solid #f59e0b;">
                            <strong style="color: #92400e;"><i class="fas fa-exclamation-triangle"></i> Impact:</strong>
                            <span style="color: #78350f;"> ${escapeHtml(issue.impact_if_not_fixed)}</span>
                        </div>
                    ` : ''}
                    ${issue.suggestion ? `<div class="issue-suggestion"><i class="fas fa-lightbulb"></i> <strong>Suggestion:</strong> ${escapeHtml(issue.suggestion)}</div>` : ''}
                </li>
            `;
        });
        html += `
                </ul>
            </div>
        `;
    }

    // Recommendations Section
    if (review.recommendations && review.recommendations.length > 0) {
        html += `
            <div class="feedback-section">
                <h3><i class="fas fa-star" style="color: #3b82f6;"></i> Recommendations</h3>
                <ul class="recommendation-list">
        `;
        review.recommendations.forEach(rec => {
            html += `
                <li>
                    <i class="fas fa-arrow-right"></i>
                    <span>${escapeHtml(rec)}</span>
                </li>
            `;
        });
        html += `
                </ul>
            </div>
        `;
    }

    // Correctness Analysis Section
    if (review.correctness_analysis) {
        html += `
            <div class="feedback-section">
                <h3><i class="fas fa-magnifying-glass"></i> Correctness Analysis</h3>
                <div class="analysis-text">${escapeHtml(review.correctness_analysis)}</div>
            </div>
        `;
    }

    feedbackContainer.innerHTML = html;
}

function copyAllFiles() {
    if (!generatedFiles) {
        showToast('No files generated yet!', 'error');
        return;
    }

    const featureName = generatedFiles.feature_name;
    const allContent = `
=== ${featureName}.robot ===
${generatedFiles.robot_file}

=== ${featureName}.py ===
${generatedFiles.python_file}

=== ${featureName}_Data.py ===
${generatedFiles.data_file}
    `.trim();

    navigator.clipboard.writeText(allContent).then(() => {
        showToast('All files copied to clipboard!', 'success');
    }).catch(err => {
        console.error('Error copying files:', err);
        showToast('Error copying files', 'error');
    });
}

function downloadAllFiles() {
    if (!generatedFiles) {
        showToast('No files generated yet!', 'error');
        return;
    }

    const featureName = generatedFiles.feature_name;

    // Create a helper function to download individual files
    function downloadFile(filename, content) {
        const blob = new Blob([content], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Download all three files
    downloadFile(`${featureName}.robot`, generatedFiles.robot_file);
    setTimeout(() => downloadFile(`${featureName}.py`, generatedFiles.python_file), 200);
    setTimeout(() => downloadFile(`${featureName}_Data.py`, generatedFiles.data_file), 400);

    showToast('All files downloaded!', 'success');
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function formatDate(timestamp) {
    const date = new Date(timestamp * 1000);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}
</script>
{% endblock %}
